<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Data ‚Äî GraphDB</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #242836;
            --border: #2e3345;
            --text: #e1e4ed;
            --text-dim: #8b90a0;
            --accent: #6c5ce7;
            --accent-hover: #7d6ff0;
            --success: #00b894;
            --error: #ff6b6b;
            --warning: #ffc107;
            --radius: 12px;
            --font: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        header .icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), #a29bfe);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #e1e4ed, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-dim);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--surface);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .tab:hover:not(.active) {
            color: var(--text);
            background: var(--surface-2);
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--surface);
            margin-bottom: 24px;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.05);
        }

        .upload-zone .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-zone p {
            color: var(--text-dim);
            font-size: 14px;
        }

        .upload-zone .filename {
            color: var(--success);
            font-weight: 600;
            margin-top: 8px;
        }

        /* Config Section */
        .config-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .config-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .config-field label {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="text"] {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: var(--font);
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus,
        input[type="text"]:focus {
            border-color: var(--accent);
        }

        /* Data Preview */
        .preview-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th {
            background: var(--surface-2);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
        }

        .preview-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-table tr:hover td {
            background: rgba(108, 92, 231, 0.04);
        }

        /* Mapping */
        .mapping-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .mapping-row:last-child {
            border-bottom: none;
        }

        .mapping-source {
            font-family: var(--mono);
            font-size: 13px;
            min-width: 150px;
            color: var(--text);
            background: var(--surface-2);
            padding: 6px 10px;
            border-radius: 6px;
        }

        .mapping-arrow {
            color: var(--text-dim);
            font-size: 18px;
        }

        .mapping-target select {
            min-width: 160px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #a29bfe);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Results */
        .result-box {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
        }

        .result-box.success {
            border-color: var(--success);
        }

        .result-box.error {
            border-color: var(--error);
        }

        .result-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .errors-list {
            max-height: 300px;
            overflow-y: auto;
            font-family: var(--mono);
            font-size: 12px;
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }

        .error-item {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            color: var(--error);
        }

        /* API Docs */
        .api-section {
            margin-bottom: 24px;
        }

        .api-section h4 {
            margin-bottom: 8px;
            color: var(--accent);
        }

        pre {
            background: var(--surface-2);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: var(--mono);
            font-size: 13px;
            line-height: 1.5;
            color: #abb2bf;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-post {
            background: var(--success);
            color: #000;
        }

        .badge-get {
            background: #3498db;
            color: #fff;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--surface-2);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 3px;
            transition: width 0.3s;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="icon">üì•</div>
            <div>
                <h1>Import Data</h1>
                <p>Importar datos masivos desde CSV, JSON o XLSX a GraphDB</p>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="import" onclick="switchTab('import')">üì§ Importar</button>
            <button class="tab" data-tab="docs" onclick="switchTab('docs')">üìñ API Docs</button>
        </div>

        <!-- ============ IMPORT TAB ============ -->
        <div id="panel-import" class="panel active">
            <!-- Step 1: Upload -->
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <p>Arrastra un archivo aqu√≠ o haz clic para seleccionar</p>
                <p style="font-size: 12px; margin-top: 4px;">CSV, JSON, XLSX</p>
                <div class="filename hidden" id="fileName"></div>
            </div>
            <input type="file" id="fileInput" accept=".csv,.json,.xlsx,.tsv" style="display:none">

            <!-- Step 2: Config -->
            <div class="config-section hidden" id="configSection">
                <h3>‚öôÔ∏è Configuraci√≥n</h3>
                <div class="config-row">
                    <div class="config-field">
                        <label>Colecci√≥n destino</label>
                        <select id="targetCollection" onchange="updateMappingTargets()">
                            <option value="entities" selected>Entities (Entidades)</option>
                            <option value="claims">Claims (Declaraciones)</option>
                            <option value="qualifiers">Qualifiers (Calificadores)</option>
                            <option value="references">References (Referencias)</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>Modo de inserci√≥n</label>
                        <select id="insertMode">
                            <option value="single">Fila por fila</option>
                            <option value="batch">Batch (lotes)</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>API Key (opcional)</label>
                        <input type="text" id="apiKey" placeholder="Usar la del servidor" style="width: 200px;">
                    </div>
                </div>
            </div>

            <!-- Step 3: Preview -->
            <div class="config-section hidden" id="previewSection">
                <h3>üìã Vista previa <span id="rowCount" style="color:var(--text-dim); font-weight:400"></span></h3>
                <div class="preview-table-wrapper">
                    <table class="preview-table" id="previewTable">
                        <thead id="previewHead"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 4: Mapping -->
            <div class="config-section hidden" id="mappingSection">
                <h3>üîó Mapeo de campos</h3>
                <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 12px;">
                    Asigna cada columna del archivo a un campo de la colecci√≥n destino
                </p>
                <div id="mappingList"></div>
            </div>

            <!-- Import Button -->
            <div class="hidden" id="importActions" style="margin: 24px 0; text-align:center;">
                <button class="btn btn-primary" id="importBtn" onclick="runImport()">
                    üöÄ Iniciar importaci√≥n
                </button>
            </div>

            <!-- Progress -->
            <div class="hidden" id="progressSection" style="margin-bottom: 24px;">
                <div class="config-section">
                    <h3><span class="spinner"></span> Importando...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                    <p id="progressText" style="color:var(--text-dim);font-size:13px;">Procesando...</p>
                </div>
            </div>

            <!-- Results -->
            <div class="hidden" id="resultSection"></div>
        </div>

        <!-- ============ DOCS TAB ============ -->
        <div id="panel-docs" class="panel">
            <div class="config-section">
                <h3>üìñ Documentaci√≥n de la API</h3>
                <p style="color: var(--text-dim); margin-bottom: 24px;">
                    Usa esta funci√≥n para importar datos masivos program√°ticamente v√≠a POST.
                </p>

                <div class="api-section">
                    <h4><span class="badge badge-post">POST</span> Importar datos desde CSV</h4>
                    <pre>curl -X POST "{{APPWRITE_ENDPOINT}}/v1/functions/import-data/executions" \
  -H "Content-Type: application/json" \
  -H "X-Appwrite-Project: {{APPWRITE_PROJECT_ID}}" \
  -H "X-Appwrite-Key: YOUR_API_KEY" \
  -d '{
    "body": "{\"targetCollection\":\"entities\",\"format\":\"csv\",\"hasHeader\":true,\"csvData\":\"label,description,aliases\\nPlaneta Tierra,Tercer planeta del sistema solar,Tierra|Terra|Earth\\nLuna,Sat√©lite natural de la Tierra,Luna|Moon\",\"fields\":[{\"source\":\"label\",\"target\":\"label\"},{\"source\":\"description\",\"target\":\"description\"},{\"source\":\"aliases\",\"target\":\"aliases\",\"transform\":\"array\"}]}"
  }'</pre>
                </div>

                <div class="api-section">
                    <h4><span class="badge badge-post">POST</span> Importar datos pre-procesados (JSON)</h4>
                    <pre>curl -X POST "{{APPWRITE_ENDPOINT}}/v1/functions/import-data/executions" \
  -H "Content-Type: application/json" \
  -H "X-Appwrite-Project: {{APPWRITE_PROJECT_ID}}" \
  -H "X-Appwrite-Key: YOUR_API_KEY" \
  -d '{
    "body": "{\"targetCollection\":\"entities\",\"rows\":[{\"name\":\"Entidad 1\",\"desc\":\"Descripci√≥n 1\"},{\"name\":\"Entidad 2\",\"desc\":\"Descripci√≥n 2\"}],\"fields\":[{\"source\":\"name\",\"target\":\"label\"},{\"source\":\"desc\",\"target\":\"description\"}]}"
  }'</pre>
                </div>

                <div class="api-section">
                    <h4><span class="badge badge-post">POST</span> Importar Claims en lotes</h4>
                    <pre>curl -X POST "{{APPWRITE_ENDPOINT}}/v1/functions/import-data/executions" \
  -H "Content-Type: application/json" \
  -H "X-Appwrite-Project: {{APPWRITE_PROJECT_ID}}" \
  -H "X-Appwrite-Key: YOUR_API_KEY" \
  -d '{
    "body": "{\"targetCollection\":\"claims\",\"useBatch\":true,\"batchSize\":50,\"rows\":[{\"sub\":\"entity-id-1\",\"prop\":\"property-id\",\"val\":\"Valor\"}],\"fields\":[{\"source\":\"sub\",\"target\":\"subject\"},{\"source\":\"prop\",\"target\":\"property\"},{\"source\":\"val\",\"target\":\"value_raw\"}]}"
  }'</pre>
                </div>

                <div class="api-section">
                    <h4>üì¶ Esquema del Request Body</h4>
                    <pre>{
  "targetCollection": "entities" | "claims" | "qualifiers" | "references",
  "format": "csv" | "json",    // formato del dato enviado
  "hasHeader": true,            // si el CSV tiene cabecera
  "delimiter": ",",             // separador (por defecto coma)
  "useBatch": false,            // true para insertar en lotes
  "batchSize": 50,              // tama√±o de cada lote

  // Datos (usar UNA de estas opciones):
  "csvData": "col1,col2\nval1,val2",       // CSV como string
  "jsonData": [{"col1":"val1"}],            // JSON con rows
  "rows": [{"col1":"val1","col2":"val2"}],  // Rows pre-parseados

  // Mapeo de campos (REQUERIDO):
  "fields": [
    {
      "source": "col1",       // nombre de columna en el archivo
      "target": "label",      // campo destino en la colecci√≥n
      "defaultValue": "",     // valor por defecto si est√° vac√≠o
      "transform": "string"   // string | number | boolean | json | array
    }
  ]
}</pre>
                </div>

                <div class="api-section">
                    <h4>üìã Campos v√°lidos por colecci√≥n</h4>
                    <pre>entities:    label, description, aliases
claims:      subject, property, datatype, value_raw, value_relation
qualifiers:  claim, property, datatype, value_raw, value_relation
references:  claim, reference, details</pre>
                </div>

                <div class="api-section">
                    <h4>‚úÖ Respuesta exitosa</h4>
                    <pre>{
  "success": true,
  "total": 100,
  "created": 98,
  "errors": [
    { "row": 5, "error": "Invalid document structure", "data": {...} },
    { "row": 23, "error": "Document limit exceeded", "data": {...} }
  ],
  "hasMoreErrors": false
}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let fileHeaders = [];
        let fileRows = [];
        let allRows = [];

        const COLLECTION_FIELDS = {
            entities: ['label', 'description', 'aliases'],
            claims: ['subject', 'property', 'datatype', 'value_raw', 'value_relation'],
            qualifiers: ['claim', 'property', 'datatype', 'value_raw', 'value_relation'],
            references: ['claim', 'reference', 'details'],
        };

        const TRANSFORMS = ['string', 'number', 'boolean', 'json', 'array'];

        // ============ TABS ============
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        // ============ FILE HANDLING ============
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', e => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const fileName = document.getElementById('fileName');
            fileName.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            fileName.classList.remove('hidden');

            const ext = file.name.split('.').pop().toLowerCase();

            if (ext === 'csv' || ext === 'tsv') {
                const reader = new FileReader();
                reader.onload = e => {
                    parseCsv(e.target.result, ext === 'tsv' ? '\t' : ',');
                };
                reader.readAsText(file);
            } else if (ext === 'json') {
                const reader = new FileReader();
                reader.onload = e => {
                    parseJson(e.target.result);
                };
                reader.readAsText(file);
            } else if (ext === 'xlsx') {
                const reader = new FileReader();
                reader.onload = e => {
                    parseXlsx(e.target.result);
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Formato no soportado. Usa CSV, JSON o XLSX.');
            }
        }

        function parseCsv(text, separator = ',') {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (!lines.length) return;

            fileHeaders = parseDelimitedLine(lines[0], separator);
            allRows = lines.slice(1).map(line => {
                const values = parseDelimitedLine(line, separator);
                const row = {};
                fileHeaders.forEach((h, i) => { row[h] = values[i] || ''; });
                return row;
            });

            fileRows = allRows.slice(0, 10);
            showDataPreview();
        }

        function parseDelimitedLine(line, sep) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (c === '"') {
                    if (inQuotes && line[i + 1] === '"') { current += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if (c === sep && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += c;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseJson(text) {
            try {
                let data = JSON.parse(text);
                if (!Array.isArray(data)) {
                    data = data.data || data.items || data.rows || [];
                }
                if (!data.length) { alert('No se encontraron filas en el JSON.'); return; }

                if (Array.isArray(data[0])) {
                    fileHeaders = data[0].map(v => String(v));
                    allRows = data.slice(1).map(values => {
                        const row = {};
                        fileHeaders.forEach((h, i) => { row[h] = values[i] || ''; });
                        return row;
                    });
                } else {
                    fileHeaders = Object.keys(data[0]);
                    allRows = data;
                }

                fileRows = allRows.slice(0, 10);
                showDataPreview();
            } catch (e) {
                alert('Error parseando JSON: ' + e.message);
            }
        }

        function parseXlsx(buffer) {
            try {
                // Use a simple approach ‚Äî send as text for the function to handle
                // For the UI preview, we'll use SheetJS CDN
                alert('Para archivos XLSX, recomendamos convertir a CSV primero o usar la API program√°tica.');
            } catch (e) {
                alert('Error con archivo XLSX: ' + e.message);
            }
        }

        // ============ PREVIEW ============
        function showDataPreview() {
            document.getElementById('configSection').classList.remove('hidden');
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('mappingSection').classList.remove('hidden');
            document.getElementById('importActions').classList.remove('hidden');

            document.getElementById('rowCount').textContent = `(${allRows.length} filas totales, mostrando ${fileRows.length})`;

            // Table head
            const thead = document.getElementById('previewHead');
            thead.innerHTML = '<tr>' + fileHeaders.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';

            // Table body
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = fileRows.map(row =>
                '<tr>' + fileHeaders.map(h => `<td title="${escapeHtml(String(row[h] || ''))}">${escapeHtml(String(row[h] || ''))}</td>`).join('') + '</tr>'
            ).join('');

            // Mapping
            buildMappingUI();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ============ MAPPING ============
        function buildMappingUI() {
            const target = document.getElementById('targetCollection').value;
            const targetFields = COLLECTION_FIELDS[target] || [];
            const list = document.getElementById('mappingList');

            list.innerHTML = fileHeaders.map((header, i) => {
                const autoTarget = autoMapField(header, targetFields);
                return `
                <div class="mapping-row">
                    <div class="mapping-source">${escapeHtml(header)}</div>
                    <span class="mapping-arrow">‚Üí</span>
                    <div class="mapping-target">
                        <select id="map-target-${i}">
                            <option value="">(ignorar)</option>
                            ${targetFields.map(f => `<option value="${f}" ${f === autoTarget ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mapping-target">
                        <select id="map-transform-${i}">
                            ${TRANSFORMS.map(t => `<option value="${t}" ${t === autoTransform(autoTarget) ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            }).join('');
        }

        function autoMapField(header, targetFields) {
            const h = header.toLowerCase().trim();
            for (const f of targetFields) {
                if (h === f || h.includes(f) || f.includes(h)) return f;
            }
            // Common synonyms
            const synonyms = {
                'nombre': 'label', 'name': 'label', 'etiqueta': 'label', 'titulo': 'label', 'title': 'label',
                'descripcion': 'description', 'desc': 'description',
                'alias': 'aliases', 'sin√≥nimos': 'aliases', 'synonyms': 'aliases',
                'sujeto': 'subject', 'propiedad': 'property', 'valor': 'value_raw', 'value': 'value_raw',
                'tipo': 'datatype', 'type': 'datatype', 'referencia': 'reference', 'ref': 'reference',
                'detalles': 'details', 'detail': 'details',
            };
            if (synonyms[h] && targetFields.includes(synonyms[h])) return synonyms[h];
            return '';
        }

        function autoTransform(target) {
            if (target === 'aliases') return 'array';
            return 'string';
        }

        function updateMappingTargets() {
            if (fileHeaders.length > 0) buildMappingUI();
        }

        // ============ IMPORT ============
        async function runImport() {
            const targetCollection = document.getElementById('targetCollection').value;
            const insertMode = document.getElementById('insertMode').value;
            const apiKeyInput = document.getElementById('apiKey').value.trim();

            // Build field mappings
            const fields = [];
            for (let i = 0; i < fileHeaders.length; i++) {
                const target = document.getElementById(`map-target-${i}`).value;
                const transform = document.getElementById(`map-transform-${i}`).value;
                if (target) {
                    fields.push({
                        source: fileHeaders[i],
                        target,
                        transform,
                    });
                }
            }

            if (fields.length === 0) {
                alert('Debes mapear al menos un campo.');
                return;
            }

            // Show progress
            document.getElementById('importActions').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = '10%';
            progressText.textContent = `Enviando ${allRows.length} filas...`;

            try {
                const payload = {
                    targetCollection,
                    rows: allRows,
                    fields,
                    useBatch: insertMode === 'batch',
                    batchSize: 50,
                };

                // Determine the endpoint: call our own function
                const functionUrl = window.location.href.split('?')[0];

                const headers = {
                    'Content-Type': 'application/json',
                };

                if (apiKeyInput) {
                    headers['X-Appwrite-Key'] = apiKeyInput;
                }

                progressFill.style.width = '30%';
                progressText.textContent = 'Procesando importaci√≥n en el servidor...';

                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload),
                });

                progressFill.style.width = '90%';

                const result = await response.json();

                progressFill.style.width = '100%';
                document.getElementById('progressSection').classList.add('hidden');

                showResults(result);
            } catch (err) {
                document.getElementById('progressSection').classList.add('hidden');
                showResults({ success: false, error: err.message, total: allRows.length, created: 0, errors: [] });
            }
        }

        function showResults(result) {
            const section = document.getElementById('resultSection');
            section.classList.remove('hidden');
            document.getElementById('importActions').classList.remove('hidden');

            if (result.success) {
                section.innerHTML = `
                <div class="result-box success">
                    <h3 style="color: var(--success); margin-bottom: 16px;">‚úÖ Importaci√≥n completada</h3>
                    <div class="result-stats">
                        <div class="stat">
                            <div class="stat-value">${result.total}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="color: var(--success)">${result.created}</div>
                            <div class="stat-label">Creados</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="color: ${result.errors?.length ? 'var(--error)' : 'var(--text-dim)'}">${result.errors?.length || 0}</div>
                            <div class="stat-label">Errores</div>
                        </div>
                    </div>
                    ${result.errors?.length ? `
                        <h4 style="margin-bottom: 8px;">Errores:</h4>
                        <div class="errors-list">
                            ${result.errors.map(e => `<div class="error-item">Fila ${e.row}: ${escapeHtml(e.error)}</div>`).join('')}
                        </div>
                        ${result.hasMoreErrors ? '<p style="color:var(--warning);margin-top:8px;">‚ö†Ô∏è Se muestran los primeros 50 errores.</p>' : ''}
                    ` : ''}
                </div>
            `;
            } else {
                section.innerHTML = `
                <div class="result-box error">
                    <h3 style="color: var(--error); margin-bottom: 8px;">‚ùå Error en la importaci√≥n</h3>
                    <pre>${escapeHtml(result.error || JSON.stringify(result, null, 2))}</pre>
                </div>
            `;
            }
        }
    </script>
</body>

</html>